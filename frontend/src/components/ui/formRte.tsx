import { Color } from "@tiptap/extension-color";
import ListItem from "@tiptap/extension-list-item";
import TextStyle from "@tiptap/extension-text-style";
import { EditorProvider, useCurrentEditor } from "@tiptap/react";
import StarterKit from "@tiptap/starter-kit";
import { Dispatch, SetStateAction } from "react";
import Placeholder from "@tiptap/extension-placeholder";
import { FieldValues, Path, PathValue, UseFormReturn } from "react-hook-form";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";

const MenuBar = () => {
  const { editor } = useCurrentEditor();

  if (!editor) {
    return null;
  }

  return (
    <div className="control-group">
      <div className="Button-group flex h-[40px] items-center gap-3.5 rounded-t-lg border-[1.5px] border-b-0 border-[#E5E7EB] bg-[#F9FAFB] px-5">
        <input type="image" className="hidden" />
        <svg
          className={"cursor-pointer "}
          xmlns="http://www.w3.org/2000/svg"
          width="12"
          height="14"
          viewBox="0 0 12 14"
          fill="none"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M4.3999 2.2001C3.76338 2.2001 3.15293 2.45295 2.70285 2.90304C2.25276 3.35313 1.9999 3.96358 1.9999 4.6001V7.8001C1.9999 8.86096 2.42133 9.87838 3.17148 10.6285C3.92162 11.3787 4.93904 11.8001 5.9999 11.8001C7.06077 11.8001 8.07818 11.3787 8.82833 10.6285C9.57848 9.87838 9.9999 8.86096 9.9999 7.8001V4.6001C9.9999 4.38792 10.0842 4.18444 10.2342 4.03441C10.3842 3.88438 10.5877 3.8001 10.7999 3.8001C11.0121 3.8001 11.2156 3.88438 11.3656 4.03441C11.5156 4.18444 11.5999 4.38792 11.5999 4.6001V7.8001C11.5999 8.5355 11.4551 9.2637 11.1736 9.94312C10.8922 10.6225 10.4797 11.2399 9.9597 11.7599C9.43969 12.2799 8.82235 12.6924 8.14293 12.9738C7.46351 13.2552 6.73531 13.4001 5.9999 13.4001C5.2645 13.4001 4.5363 13.2552 3.85688 12.9738C3.17745 12.6924 2.56011 12.2799 2.0401 11.7599C1.5201 11.2399 1.1076 10.6225 0.826177 9.94312C0.544751 9.2637 0.399902 8.5355 0.399902 7.8001V4.6001C0.399902 3.53923 0.82133 2.52182 1.57148 1.77167C2.32162 1.02152 3.33904 0.600098 4.3999 0.600098C5.46077 0.600098 6.47818 1.02152 7.22833 1.77167C7.97848 2.52182 8.3999 3.53923 8.3999 4.6001V7.8001C8.3999 8.43662 8.14705 9.04707 7.69696 9.49715C7.24687 9.94724 6.63642 10.2001 5.9999 10.2001C5.36338 10.2001 4.75293 9.94724 4.30285 9.49715C3.85276 9.04707 3.5999 8.43662 3.5999 7.8001V4.6001C3.5999 4.38792 3.68419 4.18444 3.83422 4.03441C3.98425 3.88438 4.18773 3.8001 4.3999 3.8001C4.61208 3.8001 4.81556 3.88438 4.96559 4.03441C5.11562 4.18444 5.1999 4.38792 5.1999 4.6001V7.8001C5.1999 8.01227 5.28419 8.21575 5.43422 8.36578C5.58425 8.51581 5.78773 8.6001 5.9999 8.6001C6.21208 8.6001 6.41556 8.51581 6.56559 8.36578C6.71562 8.21575 6.7999 8.01227 6.7999 7.8001V4.6001C6.7999 3.96358 6.54705 3.35313 6.09696 2.90304C5.64687 2.45295 5.03642 2.2001 4.3999 2.2001Z"
            fill="#6B7280"
          />
        </svg>
        <input type="file" className="hidden" />
        <svg
          className={"cursor-pointer "}
          xmlns="http://www.w3.org/2000/svg"
          width="14"
          height="12"
          viewBox="0 0 14 12"
          fill="none"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M2.2001 0.399902C1.77575 0.399902 1.36878 0.568473 1.06873 0.868531C0.768669 1.16859 0.600098 1.57556 0.600098 1.9999V9.9999C0.600098 10.4242 0.768669 10.8312 1.06873 11.1313C1.36878 11.4313 1.77575 11.5999 2.2001 11.5999H11.8001C12.2244 11.5999 12.6314 11.4313 12.9315 11.1313C13.2315 10.8312 13.4001 10.4242 13.4001 9.9999V1.9999C13.4001 1.57556 13.2315 1.16859 12.9315 0.868531C12.6314 0.568473 12.2244 0.399902 11.8001 0.399902H2.2001ZM11.8001 9.9999H2.2001L5.4001 3.5999L7.8001 8.3999L9.4001 5.1999L11.8001 9.9999Z"
            fill="#6B7280"
          />
        </svg>
        <svg
          onClick={() => editor.chain().focus().toggleCode().run()}
          className={
            "cursor-pointer " +
            (editor.isActive("code") ? "is-active " : "") +
            (!editor.can().chain().focus().toggleCode().run()
              ? "cursor-not-allowed"
              : "")
          }
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="12"
          viewBox="0 0 16 12"
          fill="none"
        >
          <path
            d="M2.02422 6.00013L2.37777 5.64658L4.21212 3.81223C4.21213 3.81222 4.21215 3.8122 4.21217 3.81218C4.26838 3.75593 4.29995 3.67966 4.29995 3.60013C4.29995 3.52063 4.2684 3.44439 4.21222 3.38814C4.21219 3.3881 4.21215 3.38807 4.21212 3.38803M2.02422 6.00013L4.21212 3.38803M2.02422 6.00013L2.37777 6.35369L4.21217 8.18809L4.21212 8.18814L4.21837 8.19418C4.24702 8.22185 4.26987 8.25496 4.2856 8.29156C4.30132 8.32816 4.3096 8.36752 4.30994 8.40736C4.31029 8.44719 4.3027 8.4867 4.28761 8.52356C4.27253 8.56043 4.25025 8.59393 4.22208 8.6221C4.19392 8.65026 4.16042 8.67254 4.12355 8.68762C4.08668 8.70271 4.04718 8.7103 4.00735 8.70995C3.96751 8.70961 3.92815 8.70133 3.89155 8.68561C3.85494 8.66989 3.82184 8.64703 3.79417 8.61838L3.79422 8.61833L3.78808 8.61218L1.38813 6.21223C1.33189 6.15598 1.30029 6.07968 1.30029 6.00013C1.30029 5.92061 1.33187 5.84434 1.38808 5.78809C1.38809 5.78807 1.38811 5.78805 1.38813 5.78803L3.78802 3.38814M2.02422 6.00013L3.78802 3.38814M4.21212 3.38803C4.15587 3.33186 4.07962 3.3003 4.00012 3.3003C3.9206 3.3003 3.84433 3.33188 3.78808 3.38809M4.21212 3.38803L3.78808 3.38809M3.78808 3.38809L3.78802 3.38814M3.78808 3.38809L3.78802 3.38814M12.2121 8.61213L12.2122 8.61218L14.6121 6.21223C14.6121 6.21222 14.6122 6.2122 14.6122 6.21218C14.6684 6.15593 14.7 6.07966 14.7 6.00013C14.7 5.92061 14.6684 5.84434 14.6122 5.78809L12.2121 8.61213ZM12.2121 8.61213L12.2061 8.61838C12.1784 8.64703 12.1453 8.66989 12.1087 8.68561L12.306 9.14501L12.1087 8.68561C12.0721 8.70133 12.0327 8.70961 11.9929 8.70995C11.9531 8.7103 11.9136 8.70271 11.8767 8.68762C11.8398 8.67254 11.8063 8.65026 11.7782 8.62209C11.75 8.59393 11.7277 8.56043 11.7126 8.52357L11.2499 8.7129L11.7126 8.52356C11.6975 8.48669 11.69 8.44719 11.6903 8.40736C11.6906 8.36753 11.6989 8.32816 11.7146 8.29155C11.7304 8.25496 11.7532 8.22185 11.7819 8.19418L11.7819 8.19423L11.7881 8.18809L13.6225 6.35369L13.976 6.00013L13.6225 5.64658L11.7881 3.81223C11.7881 3.81222 11.7881 3.8122 11.7881 3.81218C11.7319 3.75593 11.7003 3.67966 11.7003 3.60013C11.7003 3.52063 11.7318 3.44439 11.788 3.38814C11.8443 3.3319 11.9206 3.3003 12.0001 3.3003C12.0796 3.3003 12.1559 3.33188 12.2122 3.38809C12.2122 3.38811 12.2122 3.38812 12.2122 3.38814L14.6121 5.78803L12.2121 8.61213ZM9.69485 0.91529L9.69507 0.915361C9.73246 0.927803 9.76704 0.94749 9.79682 0.973297C9.8266 0.999105 9.85101 1.03053 9.86864 1.06577C9.88627 1.10101 9.89679 1.13938 9.8996 1.17869C9.9024 1.218 9.89742 1.25748 9.88497 1.29486L6.68498 10.8948L6.68493 10.895C6.65978 10.9705 6.60565 11.033 6.53445 11.0686C6.46326 11.1042 6.38082 11.1101 6.30529 11.0849L6.14732 11.5593L6.30528 11.0849C6.22975 11.0598 6.1673 11.0057 6.13167 10.9345C6.09607 10.8633 6.09017 10.7809 6.11526 10.7054C6.11528 10.7054 6.1153 10.7053 6.11531 10.7053L9.31526 1.10545L9.31535 1.10519C9.32779 1.0678 9.34748 1.03322 9.37329 1.00344C9.39909 0.973657 9.43052 0.949252 9.46576 0.931617C9.501 0.913982 9.53937 0.903463 9.57868 0.900661C9.61799 0.89786 9.65746 0.90283 9.69485 0.91529Z"
            fill="#6B7280"
            stroke="#6B7280"
          />
        </svg>
        <svg
          className={"cursor-pointer "}
          xmlns="http://www.w3.org/2000/svg"
          width="14"
          height="13"
          viewBox="0 0 14 13"
          fill="none"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M7.0001 12.9001C8.69748 12.9001 10.3253 12.2258 11.5256 11.0256C12.7258 9.82535 13.4001 8.19748 13.4001 6.5001C13.4001 4.80271 12.7258 3.17485 11.5256 1.97461C10.3253 0.774382 8.69748 0.100098 7.0001 0.100098C5.30271 0.100098 3.67485 0.774382 2.47461 1.97461C1.27438 3.17485 0.600098 4.80271 0.600098 6.5001C0.600098 8.19748 1.27438 9.82535 2.47461 11.0256C3.67485 12.2258 5.30271 12.9001 7.0001 12.9001ZM4.6001 5.7001C4.81227 5.7001 5.01575 5.61581 5.16578 5.46578C5.31581 5.31575 5.4001 5.11227 5.4001 4.9001C5.4001 4.68792 5.31581 4.48444 5.16578 4.33441C5.01575 4.18438 4.81227 4.1001 4.6001 4.1001C4.38792 4.1001 4.18444 4.18438 4.03441 4.33441C3.88438 4.48444 3.8001 4.68792 3.8001 4.9001C3.8001 5.11227 3.88438 5.31575 4.03441 5.46578C4.18444 5.61581 4.38792 5.7001 4.6001 5.7001ZM10.2001 4.9001C10.2001 5.11227 10.1158 5.31575 9.96578 5.46578C9.81575 5.61581 9.61227 5.7001 9.4001 5.7001C9.18792 5.7001 8.98444 5.61581 8.83441 5.46578C8.68438 5.31575 8.6001 5.11227 8.6001 4.9001C8.6001 4.68792 8.68438 4.48444 8.83441 4.33441C8.98444 4.18438 9.18792 4.1001 9.4001 4.1001C9.61227 4.1001 9.81575 4.18438 9.96578 4.33441C10.1158 4.48444 10.2001 4.68792 10.2001 4.9001ZM9.8289 9.3281C9.90317 9.25377 9.96208 9.16554 10.0023 9.06844C10.0424 8.97135 10.0631 8.86729 10.0631 8.76221C10.063 8.65714 10.0423 8.55309 10.002 8.45603C9.9618 8.35896 9.90283 8.27077 9.8285 8.1965C9.75417 8.12222 9.66594 8.06331 9.56884 8.02314C9.47175 7.98296 9.36769 7.9623 9.26261 7.96234C9.15754 7.96237 9.05349 7.98311 8.95643 8.02335C8.85936 8.0636 8.77117 8.12257 8.6969 8.1969C8.24683 8.64683 7.63649 8.89958 7.0001 8.89958C6.3637 8.89958 5.75336 8.64683 5.3033 8.1969C5.15329 8.04678 4.9498 7.96241 4.73758 7.96234C4.52536 7.96226 4.32181 8.04649 4.1717 8.1965C4.02158 8.3465 3.93721 8.55 3.93714 8.76221C3.93706 8.97443 4.02129 9.17798 4.1713 9.3281C4.54275 9.69964 4.98375 9.99438 5.46912 10.1955C5.95449 10.3965 6.47472 10.5 7.0001 10.5C7.52547 10.5 8.0457 10.3965 8.53108 10.1955C9.01645 9.99438 9.45745 9.69964 9.8289 9.3281Z"
            fill="#6B7280"
          />
        </svg>
        <svg
          className="mx-2.5"
          xmlns="http://www.w3.org/2000/svg"
          width="1"
          height="17"
          viewBox="0 0 1 17"
          fill="none"
        >
          <line x1="0.5" y1="0.5" x2="0.5" y2="16.5" stroke="#D1D5DB" />
        </svg>
        <svg
          className={"cursor-pointer "}
          xmlns="http://www.w3.org/2000/svg"
          width="14"
          height="11"
          viewBox="0 0 14 11"
          fill="none"
        >
          <path
            d="M1.6665 1.5H12.3332H1.6665ZM1.6665 4.16667H12.3332H1.6665ZM1.6665 6.83333H12.3332H1.6665ZM1.6665 9.5H12.3332H1.6665Z"
            fill="#6B7280"
          />
          <path
            d="M1.6665 9.5H12.3332M1.6665 1.5H12.3332H1.6665ZM1.6665 4.16667H12.3332H1.6665ZM1.6665 6.83333H12.3332H1.6665Z"
            stroke="#6B7280"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <svg
          className={"cursor-pointer "}
          xmlns="http://www.w3.org/2000/svg"
          width="14"
          height="13"
          viewBox="0 0 14 13"
          fill="none"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M8.1919 1.0361C7.8879 -0.211902 6.1119 -0.211902 5.8079 1.0361C5.76251 1.22363 5.67349 1.3978 5.54808 1.54443C5.42266 1.69106 5.2644 1.806 5.08617 1.87991C4.90794 1.95382 4.71478 1.98461 4.52241 1.96977C4.33003 1.95493 4.14388 1.89487 3.9791 1.7945C2.8815 1.1257 1.6255 2.3817 2.2943 3.4793C2.7263 4.1881 2.3431 5.1129 1.5367 5.3089C0.287898 5.6121 0.287898 7.3889 1.5367 7.6913C1.72428 7.73674 1.89848 7.82585 2.04511 7.95135C2.19174 8.07686 2.30665 8.23523 2.38049 8.41355C2.45433 8.59188 2.48501 8.78512 2.47003 8.97755C2.45506 9.16998 2.39484 9.35615 2.2943 9.5209C1.6255 10.6185 2.8815 11.8745 3.9791 11.2057C4.14385 11.1052 4.33002 11.0449 4.52245 11.03C4.71487 11.015 4.90812 11.0457 5.08644 11.1195C5.26477 11.1933 5.42313 11.3083 5.54864 11.4549C5.67415 11.6015 5.76325 11.7757 5.8087 11.9633C6.1119 13.2121 7.8887 13.2121 8.1911 11.9633C8.2367 11.7758 8.32589 11.6017 8.45142 11.4552C8.57696 11.3087 8.7353 11.1938 8.91357 11.12C9.09184 11.0462 9.28501 11.0155 9.47739 11.0304C9.66976 11.0453 9.85591 11.1053 10.0207 11.2057C11.1183 11.8745 12.3743 10.6185 11.7055 9.5209C11.6051 9.35611 11.5451 9.16996 11.5302 8.97758C11.5153 8.78521 11.546 8.59204 11.6198 8.41377C11.6936 8.2355 11.8085 8.07716 11.955 7.95162C12.1015 7.82609 12.2756 7.7369 12.4631 7.6913C13.7119 7.3881 13.7119 5.6113 12.4631 5.3089C12.2755 5.26345 12.1013 5.17435 11.9547 5.04884C11.8081 4.92333 11.6931 4.76497 11.6193 4.58664C11.5455 4.40832 11.5148 4.21507 11.5298 4.02265C11.5447 3.83022 11.605 3.64405 11.7055 3.4793C12.3743 2.3817 11.1183 1.1257 10.0207 1.7945C9.85595 1.89504 9.66978 1.95526 9.47735 1.97023C9.28492 1.98521 9.09168 1.95453 8.91335 1.88069C8.73503 1.80685 8.57666 1.69193 8.45116 1.54531C8.32565 1.39868 8.23654 1.22448 8.1911 1.0369L8.1919 1.0361ZM6.9999 8.9001C7.63642 8.9001 8.24687 8.64724 8.69695 8.19715C9.14704 7.74707 9.3999 7.13662 9.3999 6.5001C9.3999 5.86358 9.14704 5.25313 8.69695 4.80304C8.24687 4.35295 7.63642 4.1001 6.9999 4.1001C6.36338 4.1001 5.75293 4.35295 5.30284 4.80304C4.85275 5.25313 4.5999 5.86358 4.5999 6.5001C4.5999 7.13662 4.85275 7.74707 5.30284 8.19715C5.75293 8.64724 6.36338 8.9001 6.9999 8.9001Z"
            fill="#6B7280"
          />
        </svg>
        <svg
          className={"cursor-pointer "}
          xmlns="http://www.w3.org/2000/svg"
          width="14"
          height="13"
          viewBox="0 0 14 13"
          fill="none"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M3.8001 0.100098C3.58792 0.100098 3.38444 0.184383 3.23441 0.334412C3.08438 0.484441 3.0001 0.687924 3.0001 0.900098V1.7001H2.2001C1.77575 1.7001 1.36878 1.86867 1.06873 2.16873C0.768669 2.46878 0.600098 2.87575 0.600098 3.3001V11.3001C0.600098 11.7244 0.768669 12.1314 1.06873 12.4315C1.36878 12.7315 1.77575 12.9001 2.2001 12.9001H11.8001C12.2244 12.9001 12.6314 12.7315 12.9315 12.4315C13.2315 12.1314 13.4001 11.7244 13.4001 11.3001V3.3001C13.4001 2.87575 13.2315 2.46878 12.9315 2.16873C12.6314 1.86867 12.2244 1.7001 11.8001 1.7001H11.0001V0.900098C11.0001 0.687924 10.9158 0.484441 10.7658 0.334412C10.6158 0.184383 10.4123 0.100098 10.2001 0.100098C9.98792 0.100098 9.78444 0.184383 9.63441 0.334412C9.48438 0.484441 9.4001 0.687924 9.4001 0.900098V1.7001H4.6001V0.900098C4.6001 0.687924 4.51581 0.484441 4.36578 0.334412C4.21575 0.184383 4.01227 0.100098 3.8001 0.100098ZM3.8001 4.1001C3.58792 4.1001 3.38444 4.18438 3.23441 4.33441C3.08438 4.48444 3.0001 4.68792 3.0001 4.9001C3.0001 5.11227 3.08438 5.31575 3.23441 5.46578C3.38444 5.61581 3.58792 5.7001 3.8001 5.7001H10.2001C10.4123 5.7001 10.6158 5.61581 10.7658 5.46578C10.9158 5.31575 11.0001 5.11227 11.0001 4.9001C11.0001 4.68792 10.9158 4.48444 10.7658 4.33441C10.6158 4.18438 10.4123 4.1001 10.2001 4.1001H3.8001Z"
            fill="#6B7280"
          />
        </svg>
        <svg
          className={"cursor-pointer "}
          xmlns="http://www.w3.org/2000/svg"
          width="14"
          height="13"
          viewBox="0 0 14 13"
          fill="none"
        >
          <path d="M6.99984 9.1665V1.1665V9.1665Z" fill="#6B7280" />
          <path
            d="M1.6665 9.1665V9.83317C1.6665 10.3636 1.87722 10.8723 2.25229 11.2474C2.62736 11.6225 3.13607 11.8332 3.6665 11.8332H10.3332C10.8636 11.8332 11.3723 11.6225 11.7474 11.2474C12.1225 10.8723 12.3332 10.3636 12.3332 9.83317V9.1665M9.6665 6.49984L6.99984 9.1665M6.99984 9.1665L4.33317 6.49984M6.99984 9.1665V1.1665"
            stroke="#6B7280"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>
    </div>
  );
};

interface ControlleRTEEditorProps<T extends FieldValues> {
  formObj: UseFormReturn<T>;
  name: Path<T>;
  defaultValue?: PathValue<T, Path<T>>;
  className?: string;
  placeholder?: string;
}

export function RTEForm<T extends FieldValues>({
  formObj,
  name,
  defaultValue,
  placeholder,
  className,
}: ControlleRTEEditorProps<T>) {
  const extensions = [
    Color.configure({ types: [TextStyle.name, ListItem.name] }),
    TextStyle.configure({ types: [ListItem.name] } as any),
    StarterKit.configure({
      bulletList: {
        keepMarks: true,
        keepAttributes: false, // TODO : Making this as `false` becase marks are not preserved when I try to preserve attrs, awaiting a bit of help
      },
      orderedList: {
        keepMarks: true,
        keepAttributes: false, // TODO : Making this as `false` becase marks are not preserved when I try to preserve attrs, awaiting a bit of help
      },
    }),
    Placeholder.configure({
      placeholder,
    }),
  ];
  return (
    <div>
      <FormField
        control={formObj.control}
        name={name}
        render={({ field }) => (
          <FormItem className="space-y-0">
            <FormControl>
              <EditorProvider
                slotBefore={<MenuBar />}
                extensions={extensions}
                onUpdate={({ editor }) => field.onChange(editor.getHTML())}
                content={field.value}
              ></EditorProvider>
            </FormControl>
            <FormMessage />
          </FormItem>
        )}
      />
    </div>
  );
}
