import DatasetsFilter, { Facet } from "@components/_shared/DatasetsFilter";
import QuickFilterDropdown from "@components/ui/quick-filter-dropdown";
import Head from "next/head";
import { useRouter } from "next/router";
import { useState } from "react";
import Layout from "../components/_shared/Layout";

import DatasetSearchItem from "@components/search/DatasetSearchItem";
import SearchBar from "@components/search/SearchBar";
import {
  Pagination,
  PaginationContent,
  PaginationItem,
} from "@components/ui/pagination";
import { cn } from "@lib/utils";
import { SearchDatasetsType } from "@schema/dataset.schema";
import { api } from "@utils/api";
import { ChevronLeft, ChevronRight } from "lucide-react";

export default function DatasetSearch() {
  const router = useRouter();

  let modes: Facet[] = [];
  let services: Facet[] = [];
  let updateFrequencies: Facet[] = [];
  let tags: Facet[] = [];
  let sectors: Facet[] = [];
  let orgs: Facet[] = [];
  let resourcesFormats: Facet[] = [];
  let topics: Facet[] = [];
  let groups: Facet[] = [];
  let regions: Facet[] = [];
  let metadataCreatedYear: Facet[] = [];
  let metadataCreatedDates: Facet[] = [];
  let yearsCoverage: Facet[] = [];
  const { q, sector, mode, service, region, fuel, before, after } =
    router.query;

  const startFilter: SearchDatasetsType = {
    tags: [],
    offset: 0,
    limit: 9,
    startYear: undefined,
    endYear: undefined,
    orgs: [],
    sort: "score desc, metadata_modified desc",
    mode: mode as string | undefined,
    service: service as string | undefined,
    sector: sector as string | undefined,
    fuel: fuel as string | undefined,
    before: before as string | undefined,
    after: after as string | undefined,
    region: region as string | undefined,
    publicationDate: [],
    facetsFields: `["tags", "groups", "services", "modes", "sectors","frequency","regions", "topics", "organization", "res_format", "temporal_coverage_start", "temporal_coverage_end", "metadata_created", "metadata_created_year"]`,
    showArchived: false,
    locations: [],
    query: q as string,
  };
  const [searchFilter, setSearchFilter] =
    useState<SearchDatasetsType>(startFilter);

  const [currentPage, setCurrentPage] = useState(0);
  const {
    data: { datasets, count: datasetCount, facets } = {
      datasets: [],
      facets: {} as any,
    },
  } = api.dataset.search.useQuery(searchFilter);

  for (const key in facets) {
    switch (key) {
      case "organization": {
        orgs = facets[key].items;
        break;
      }
      case "tags": {
        tags = facets[key].items;
        break;
      }
      case "groups": {
        groups = facets[key].items;
        break;
      }
      case "regions": {
        regions = facets[key].items;
        break;
      }
      case "topics": {
        topics = facets[key].items;
        break;
      }
      case "res_format": {
        resourcesFormats = facets[key].items;
        break;
      }
      case "metadata_created_year": {
        metadataCreatedYear = facets[key].items;
        break;
      }
      case "metadata_created": {
        const a = new Map<string, number>();
        let totalCount = 0;
        for (let i = 0; i < facets[key].items.length; i++) {
          const x = facets[key].items[i];
          const dateConverted = new Date(x.name);
          const today = new Date();
          const _key =
            dateConverted.getFullYear() === today.getFullYear() &&
            dateConverted.getMonth() === today.getMonth() - 1
              ? "Last month"
              : dateConverted.getFullYear().toString();
          let count = a.get(_key);
          if (!count) {
            a.set(_key, x.count);
          } else {
            count += x.count;
            a.set(_key, count!);
          }

          totalCount += x.count;
        }

        metadataCreatedDates = Array.from(a.keys()).map(
          (k) =>
            ({
              name: k,
              display_name: k,
              count: a.get(k),
            } as Facet)
        );
        metadataCreatedDates.unshift({
          name: "*",
          display_name: "All",
          count: totalCount,
        });

        break;
      }
      case "modes": {
        modes = facets[key].items;
        break;
      }
      case "services": {
        services = facets[key].items;
        break;
      }
      case "frequency": {
        updateFrequencies = facets[key].items;
        break;
      }
      case "sectors": {
        sectors = facets[key].items;
        break;
      }
      case "temporal_coverage_end":
      case "temporal_coverage_start": {
        yearsCoverage.push(...facets[key].items);
        break;
      }
      default: {
        break;
      }
    }
  }

  const pages = new Array(Math.ceil((datasetCount || 0) / 9)).fill(0);

  return (
    <>
      <Head>
        <title>Datasets</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Layout backgroundEffect effectSize="100px">
        <div className="container">
          <div className="pt-5">
            <SearchBar
              hideDatasetSuggestion
              sector={sector as string | undefined}
              region={region as string | undefined}
              mode={mode as string | undefined}
              service={service as string | undefined}
              before={before as string | undefined}
              after={after as string | undefined}
              fuel={fuel as string | undefined}
            />
          </div>
          <div className="mt-8">
            <div className="flex flex-col gap-4 lg:flex-row lg:gap-[64px]">
              <div className="mb-8 flex w-full flex-col justify-between">
                <div>
                  <div className="flex flex-col flex-wrap items-center justify-between gap-2 md:flex-row xl:flex-nowrap">
                    <div className="flex flex-col items-center gap-4 md:flex-row">
                      <span className="text-base font-medium text-gray-900">
                        Quick filters:
                      </span>
                      <div className="flex flex-wrap items-center gap-2 sm:flex-row sm:flex-nowrap">
                        <QuickFilterDropdown
                          setSearchFilter={setSearchFilter}
                          defaultValue={searchFilter.sector}
                          text="Sector"
                          resetPagination={() => setCurrentPage(0)}
                          filterFieldName="sector"
                          items={sectors}
                        />
                        <QuickFilterDropdown
                          setSearchFilter={setSearchFilter}
                          text="Mode"
                          resetPagination={() => setCurrentPage(0)}
                          filterFieldName="mode"
                          defaultValue={searchFilter.mode}
                          items={modes}
                        />
                        <QuickFilterDropdown
                          setSearchFilter={setSearchFilter}
                          text="Service"
                          filterFieldName="service"
                          resetPagination={() => setCurrentPage(0)}
                          defaultValue={searchFilter.service}
                          items={services}
                        />
                        <QuickFilterDropdown
                          setSearchFilter={setSearchFilter}
                          resetPagination={() => setCurrentPage(0)}
                          defaultValue={searchFilter.region}
                          text="Region"
                          filterFieldName="region"
                          items={regions}
                        />
                        <div className="w-full sm:hidden">
                          <QuickFilterDropdown
                            setSearchFilter={setSearchFilter}
                            hideAllOption
                            defaultValue={searchFilter.sort}
                            text="Sort by"
                            filterFieldName="sort"
                            items={[
                              {
                                display_name: "Relevance",
                                name: "score desc, metadata_modified desc",
                              },
                              {
                                display_name: "Name Ascending",
                                name: "name asc",
                              },
                              {
                                display_name: "Name Descending",
                                name: "name desc",
                              },
                              {
                                display_name: "Last Modified",
                                name: "metadata_modified desc",
                              },
                            ]}
                          />
                        </div>
                      </div>
                    </div>
                    <div className="hidden sm:block">
                      <QuickFilterDropdown
                        setSearchFilter={setSearchFilter}
                        hideAllOption
                        defaultValue={searchFilter.sort}
                        text="Sort by"
                        filterFieldName="sort"
                        items={[
                          {
                            display_name: "Relevance",
                            name: "score desc, metadata_modified desc",
                          },
                          {
                            display_name: "Name Ascending",
                            name: "name asc",
                          },
                          {
                            display_name: "Name Descending",
                            name: "name desc",
                          },
                          {
                            display_name: "Last Modified",
                            name: "metadata_modified desc",
                          },
                        ]}
                      />
                    </div>
                  </div>
                  <section className="mt-8">
                    <div className="flex flex-col gap-8">
                      {datasets.map((item, i) => (
                        <DatasetSearchItem
                          frequencies={updateFrequencies}
                          key={`dataset-result-${i}`}
                          {...item}
                        />
                      ))}
                    </div>
                  </section>
                </div>
                <Pagination className="mx-0 mt-8 justify-start">
                  <PaginationContent>
                    <PaginationItem>
                      <button
                        disabled={currentPage === 0}
                        aria-label="Go to next page"
                        className={cn(
                          "flex h-8 cursor-pointer items-center justify-center border border-gray-300 bg-white px-3 leading-tight text-gray-500 hover:bg-gray-100 hover:text-gray-700",
                          "rounded-s-lg px-2",
                          currentPage === 0 ? "cursor-not-allowed" : ""
                        )}
                        onClick={() => {
                          setSearchFilter((oldV) => ({
                            ...oldV,
                            offset: (currentPage - 1) * 9,
                          }));
                          setCurrentPage((oldV) => oldV - 1);
                        }}
                      >
                        <ChevronLeft className="h-4 w-4" />
                      </button>
                    </PaginationItem>
                    {pages.map((x, i) =>
                      i > currentPage + 2 || i < currentPage - 2 ? (
                        <></>
                      ) : (
                        <PaginationItem>
                          <button
                            disabled={currentPage === i}
                            onClick={() => {
                              setSearchFilter((oldV) => ({
                                ...oldV,
                                offset: i * 9,
                              }));
                              setCurrentPage(i);
                            }}
                            className={cn(
                              `flex h-8 cursor-pointer items-center justify-center border border-gray-300 bg-white px-3 leading-tight text-gray-500 hover:bg-gray-100 hover:text-gray-700 `,
                              currentPage === i ? "cursor-auto bg-gray-100" : ""
                            )}
                          >
                            {i + 1}
                          </button>
                        </PaginationItem>
                      )
                    )}
                    <PaginationItem>
                      <button
                        disabled={currentPage === pages.length - 1}
                        aria-label="Go to next page"
                        onClick={() => {
                          setSearchFilter((oldV) => ({
                            ...oldV,
                            offset: (currentPage + 1) * 9,
                          }));
                          setCurrentPage((oldV) => oldV + 1);
                        }}
                        className={cn(
                          "flex h-8 cursor-pointer items-center justify-center border border-gray-300 bg-white px-3 leading-tight text-gray-500 hover:bg-gray-100 hover:text-gray-700",
                          "rounded-e-lg px-2",
                          currentPage === pages.length - 1
                            ? "cursor-not-allowed"
                            : ""
                        )}
                      >
                        <ChevronRight className="h-4 w-4" />
                      </button>
                    </PaginationItem>
                  </PaginationContent>
                </Pagination>
              </div>

              <div className="order-first w-full border-l pl-5 pt-[12px] lg:order-last lg:max-w-[340px]">
                <DatasetsFilter
                  setSearchFilter={setSearchFilter}
                  resetPagination={() => setCurrentPage(0)}
                  resetFilter={() => setSearchFilter(startFilter)}
                  datasetCount={datasetCount || 0}
                  searchFilter={searchFilter}
                  metadataCreatedDates={metadataCreatedDates}
                  {...{
                    tags,
                    orgs,
                    resourcesFormats,
                    groups,
                    regions,
                    yearsCoverage,
                    modes,
                    services,
                  }}
                />
              </div>
            </div>
          </div>
        </div>
      </Layout>
    </>
  );
}
